import { type NextPage } from "next";
import Head from "next/head";
import Link from "next/link";
import { signIn, signOut, useSession } from "next-auth/react";

import { api } from "../../../utils/api";
import { URLSearchParams } from "url";
import { useRouter } from "next/router";
import { FormEventHandler } from "react";
import Navbar from "../../../components/Navbar";
import Comment from "./Comment";

const SingleRestaurant: NextPage = () => {
    const router = useRouter()
    const { restaurantId } = router.query

    const restaurant = api.restaurant.getById.useQuery({ id: String(restaurantId) });

    const createComment = api.comment.createComment.useMutation()
    const comments = api.comment.getByRestaurantId.useQuery({ id: String(restaurantId) })


    const handleSubmit = (e: React.SyntheticEvent<HTMLFormElement>) => {
        e.preventDefault()
        const form = e.currentTarget
        const formElements = form.elements as typeof form.elements & {
            comment: { value: string }
        }
        createComment.mutate({ text: formElements.comment.value, restaurantId: String(restaurantId) }, {
            onSuccess() {
                comments.refetch()
            }
        })

    }

    if (restaurant.status === "loading") return <>loading</>
    if (restaurant.status === 'error') return <>error</>
    if (restaurant.status === 'success' && comments.status === 'success')
        return (
            <>
                <Head>
                    <title>Foodly</title>
                    <meta name="description" content="Generated by create-t3-app" />
                    <link rel="icon" href="/favicon.ico" />
                </Head>
                <main >
                    <Navbar />
                    <div >
                        <p >
                            <div>{restaurant.data?.name}
                                {restaurant.data?.description}
                            </div>

                        </p>
                        <div className="flex flex-col">
                            {comments.data?.map((elem) => {
                                return <div>
                                    <Comment userId={elem.user_id} text={elem.text} />
                                </div>
                            })}
                        </div>
                        <div>
                            <form onSubmit={handleSubmit}>
                                <textarea rows={10} name='comment'></textarea>
                                <button type="submit" className="bg-white">add</button>
                            </form>
                        </div>
                    </div>
                </main>
            </>
        );
    else return <></>
};


export default SingleRestaurant;


